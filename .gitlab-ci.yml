# Use ubuntu:latest as the base Docker image for all jobs in this pipeline
image: ubuntu:latest

# 'before_script' steps are executed before each job's script
before_script:
  # Define the GRADLE_USER_HOME environment variable
  - GRADLE_USER_HOME="$(pwd)/.gradle"
  # Export the GRADLE_USER_HOME environment variable for use in all subsequent commands
  - export GRADLE_USER_HOME

# Define the stages that make up the build process
stages:
  - arduino-build # The 'arduino-build' stage builds the Arduino code
  - build         # The 'build' stage compiles the application
  - test          # The 'test' stage runs the application's tests

#Define the 'arduino-build' job
arduino-build:
   stage: arduino-build
   tags:
     - docker
   script:
     - export PATH=$PATH:/root/bin
     # Install arduino-cli
     #Print the current working directory
     - pwd
     # Change the directory to arduino folder
     - cd wio/quietquest
     # Setup the project
     - ./setup.sh
     # Compile Arduino code
     - arduino-cli compile --fqbn Seeeduino:samd:seeed_wio_terminal
   except:
     - tags

# Define the Gradle build job
build:
  image: amazoncorretto:21-alpine-jdk
  stage: build
  tags:
    - docker    # Ensure this job runs on runners with the 'docker' tag
  script:
    - cd app/quietquest                     # Change directory to the 'app/quietquest' directory inside the project
    - ./gradlew --build-cache assemble      # Execute the Gradle assemble command with caching to compile the project
  # Cache configuration for the test job
  cache:
    key: "$CI_COMMIT_REF_NAME"  # Cache key unique to the branch or tag
    policy: push               # Push the cache after successful job completion
    paths:
      - build                  # Cache the build output directory
      - .gradle                # Cache the Gradle data directory

# Define the 'test' job
test:
  stage: test
  tags:
    - docker
  script:
     - cd app/quietquest   # Change directory to the 'app/quietquest' directory inside the project
     - ./gradlew check    # Execute the Gradle check command to run unit tests
  # Configuration for using cached data in testing
  cache:
    key: "$CI_COMMIT_REF_NAME"  # Cache key unique to the branch or tag
    policy: pull               # Pull the cache before the job starts
    paths:
      - build                  # Use the cached build output directory
      - .gradle                # Use the cached Gradle data directory
